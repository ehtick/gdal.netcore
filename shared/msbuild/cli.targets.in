<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <PropertyGroup>
        <MaxRevGdalToolsOutputBase Condition="'$(MaxRevGdalToolsOutputBase)' == ''"></MaxRevGdalToolsOutputBase>
        <!-- EnsureTrailingSlash is only available since VS 2017 -->
        <MaxRevGdalToolsOutputBase Condition="'$(MaxRevGdalToolsOutputBase)' != '' AND !HasTrailingSlash('$(MaxRevGdalToolsOutputBase)')">$(MaxRevGdalToolsOutputBase)\</MaxRevGdalToolsOutputBase>
        <MaxRevGdalCliEnablePathInitializer Condition="'$(MaxRevGdalCliEnablePathInitializer)' == ''">true</MaxRevGdalCliEnablePathInitializer>
    </PropertyGroup>

    <ItemGroup>
        <None Include="$(MSBuildThisFileDirectory)..\tools\${_RID_TARGET}\**\*">
            <Link>$(MaxRevGdalToolsOutputBase)%(RecursiveDir)%(Filename)%(Extension)</Link>
            <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        </None>
    </ItemGroup>

    <ItemGroup Condition="'$(MaxRevGdalCliEnablePathInitializer)' == 'true'">
        <Compile Include="$(MSBuildThisFileDirectory)MaxRev.Gdal.CLI.PathInitializer.cs" Link="MaxRev.Gdal.CLI.PathInitializer.cs" />
        <Compile Include="$(MSBuildThisFileDirectory)MaxRev.Gdal.CLI.Helpers.cs" Link="MaxRev.Gdal.CLI.Helpers.cs" />
    </ItemGroup>

    <PropertyGroup>
        <MaxRevGdalCliRid>${_RID_TARGET}</MaxRevGdalCliRid>
        <MaxRevGdalCliToolsRoot>$(TargetDir)$(MaxRevGdalToolsOutputBase)</MaxRevGdalCliToolsRoot>
        <MaxRevGdalCliRPath>@loader_path/runtimes/${_RID_TARGET}/native</MaxRevGdalCliRPath>
        <MaxRevGdalCliRPath Condition="'$(MaxRevGdalToolsOutputBase)' != ''">@loader_path/../runtimes/${_RID_TARGET}/native</MaxRevGdalCliRPath>
    </PropertyGroup>

        <Target Name="MaxRevGdalCliFixRPath"
            AfterTargets="CopyFilesToOutputDirectory;Build"
            Condition="$([MSBuild]::IsOSPlatform('OSX')) AND $([System.String]::Copy('$(MaxRevGdalCliRid)').StartsWith('osx-')) AND Exists('/usr/bin/install_name_tool')">
        <Exec Command="if [ -d &quot;$(MaxRevGdalCliToolsRoot)&quot; ]; then find &quot;$(MaxRevGdalCliToolsRoot)&quot; -maxdepth 2 -type f -perm -111 -exec sh -c 'file -b &quot;$$1&quot; | grep -q &quot;Mach-O&quot; &amp;&amp; install_name_tool -add_rpath &quot;$(MaxRevGdalCliRPath)&quot; &quot;$$1&quot; || true' sh {} +; fi" />
    </Target>

</Project>
